x-app-build: &app-build
  context: .
  dockerfile: docker/php/Dockerfile
  args:
    WWWUSER: ${WWWUSER:-1000}
    WWWGROUP: ${WWWGROUP:-1000}

x-app-environment: &app-env
  APP_NAME: "Subscription Tracker"
  APP_ENV: local
  APP_DEBUG: 'true'
  APP_URL: http://localhost:8000
  APP_KEY: base64:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
  LOG_CHANNEL: stack
  DB_CONNECTION: mysql
  DB_HOST: db
  DB_PORT: 3306
  DB_DATABASE: subscription_tracker
  DB_USERNAME: subscription_user
  DB_PASSWORD: subscription_pass
  BROADCAST_DRIVER: log
  CACHE_STORE: redis
  SESSION_DRIVER: redis
  SESSION_LIFETIME: 120
  QUEUE_CONNECTION: redis
  REDIS_CLIENT: phpredis
  REDIS_HOST: redis
  REDIS_PORT: 6379
  REDIS_PASSWORD: null
  REDIS_CACHE_DB: 0
  REDIS_SESSION_DB: 1
  MAIL_MAILER: smtp
  MAIL_HOST: mailhog
  MAIL_PORT: 1025
  MAIL_USERNAME: null
  MAIL_PASSWORD: null
  MAIL_ENCRYPTION: null
  MAIL_FROM_ADDRESS: hello@example.com
  MAIL_FROM_NAME: SubscriptionTracker
  XDEBUG_MODE: develop,debug
  XDEBUG_CLIENT_HOST: host.docker.internal
  XDEBUG_CLIENT_PORT: 9003
  WWWUSER: ${WWWUSER:-1000}
  WWWGROUP: ${WWWGROUP:-1000}

services:
  app:
    build: *app-build
    image: laravel-app:latest
    environment: *app-env
    volumes:
      - ./:/var/www
      - composer-cache:/.composer
      - ./docker/php/conf.d/custom.ini:/usr/local/etc/php/conf.d/99-custom.ini:ro
      - ./docker/php/conf.d/xdebug.ini:/usr/local/etc/php/conf.d/99-xdebug.ini:ro
    networks:
      - internal
    depends_on:
      - db
      - redis
      - mailhog
    healthcheck:
      test: ["CMD-SHELL", "pgrep php-fpm >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

  queue:
    build: *app-build
    image: laravel-app:latest
    environment:
      <<: *app-env
      XDEBUG_MODE: off
    volumes:
      - ./:/var/www
      - composer-cache:/.composer
      - ./docker/php/conf.d/custom.ini:/usr/local/etc/php/conf.d/99-custom.ini:ro
      - ./docker/php/conf.d/xdebug.ini:/usr/local/etc/php/conf.d/99-xdebug.ini:ro
    command: ["tail", "-f", "/dev/null"]
    depends_on:
      - app
      - redis
    networks:
      - internal

  nginx:
    image: nginx:stable-alpine
    depends_on:
      - app
    ports:
      - "8000:80"
    volumes:
      - ./:/var/www
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - internal

  db:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: subscription_tracker
      MYSQL_USER: subscription_user
      MYSQL_PASSWORD: subscription_pass
      MYSQL_ROOT_PASSWORD: root_password
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max-connections=200
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u $$MYSQL_USER --password=$$MYSQL_PASSWORD"]
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    networks:
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5

  mailhog:
    image: mailhog/mailhog:v1.0.1
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - internal

networks:
  internal:
    driver: bridge

volumes:
  composer-cache:
  db-data:
