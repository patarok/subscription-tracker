#!/usr/bin/env bash

set -euo pipefail

staged_files="$(git diff --cached --name-only)"
if [[ -z "${staged_files}" ]]; then
  exit 0
fi

declare -a errors=()

if printf '%s\n' "${staged_files}" | grep -E '^vendor/laravel/sail' >/dev/null; then
  errors+=("Detected staged files under vendor/laravel/sail. Remove Sail artifacts before committing.")
fi

if printf '%s\n' "${staged_files}" | grep -E '^vendor/bin/sail$' >/dev/null; then
  errors+=("Detected vendor/bin/sail (Sail CLI). Delete it before committing.")
fi

if printf '%s\n' "${staged_files}" | grep -E 'composer\.(json|lock)$' >/dev/null; then
  if git diff --cached -- composer.json 2>/dev/null | grep -F 'laravel/sail' >/dev/null; then
    errors+=("composer.json references laravel/sail. This project uses plain docker compose only.")
  fi
  if git diff --cached -- composer.lock 2>/dev/null | grep -F '"name": "laravel/sail"' >/dev/null; then
    errors+=("composer.lock includes laravel/sail package. Remove it before committing.")
  fi
fi

if git diff --cached | grep -Ei 'vendor/bin/sail|sail (up|down|artisan|test)' >/dev/null; then
  errors+=("Staged changes reference Sail commands. Replace them with docker compose equivalents.")
fi

if ((${#errors[@]})); then
  {
    printf 'âœ– Sail guard prevented this commit:\n'
    for msg in "${errors[@]}"; do
      printf '  - %s\n' "$msg"
    done
    printf '\nUse plain docker compose commands instead (see README).\n'
  } >&2
  exit 1
fi

exit 0
